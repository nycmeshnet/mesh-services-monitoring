- name: Install deps
  ansible.builtin.apt:
    lock_timeout: 120
    update_cache: true
    pkg:
      - ca-certificates
      - iputils-ping

- name: Import the Datadog Agent role from the Datadog collection
  ansible.builtin.import_role:
    name: datadog.dd.agent
  vars:
    datadog_api_key: "{{ DATADOG_API_KEY }}"
    datadog_site: "{{ DATADOG_SITE }}"
    datadog_config:
      hostname: "{{ VM_HOSTNAME }}"
      logs_enabled: true
      tags:
        - msm_location:{{ MSM_LOCATION }}
    datadog_additional_groups: "systemd-journal"
    datadog_checks:
      journald:
        logs:
          - type: journald
            path: /var/log/journal/

- name: Install datadog-ping
  ansible.builtin.command: datadog-agent integration install -r -t datadog-ping==1.0.2
  creates: /opt/datadog-agent/embedded/lib/python*/site-packages/datadog_checks/ping/ping.py

- name: Deploy dns_check
  ansible.builtin.template:
    src: dns_check.d.conf.yaml.j2
    dest: /etc/datadog-agent/conf.d/dns_check.d/conf.yaml
    mode: "600"
    owner: dd-agent
    group: dd-agent

- name: Deploy http_check
  ansible.builtin.template:
    src: http_check.d.conf.yaml.j2
    dest: /etc/datadog-agent/conf.d/http_check.d/conf.yaml
    mode: "600"
    owner: dd-agent
    group: dd-agent

- name: Deploy ping
  ansible.builtin.template:
    src: ping.d.conf.yaml.j2
    dest: /etc/datadog-agent/conf.d/ping.d/conf.yaml
    mode: "600"
    owner: dd-agent
    group: dd-agent

- name: Deploy tcp_check
  ansible.builtin.template:
    src: tcp_check.d.conf.yaml.j2
    dest: /etc/datadog-agent/conf.d/tcp_check.d/conf.yaml
    mode: "600"
    owner: dd-agent
    group: dd-agent

- name: Reload datadog
  ansible.builtin.systemd_service:
    name: datadog-agent
    state: restarted
    enabled: true
    daemon_reload: true
